---
title: "他のレコードと違う存在になりたいレコードへ"
emoji: "🤡"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["DB", "レコード", "識別子"]
published: false
---

# TL;DR

# はじめに

データベースにおいて、データを一意に識別する手段は、システムの信頼性と効率の土台を築きます。多くのアプリケーションフレームワークは、シンプルで実績のある「Auto Increment」方式をデフォルトの識別子として採用しています。これは、連続して増加する数値を使い、データベースの各レコードにユニークなIDを割り振る方法です。この方法の単純さは、特に単一データベースサーバーや小規模アプリケーションにおいて強みとなります。

しかし、現代のアプリケーションは、シンプルなブログやウェブショップを越え、分散システム、マイクロサービスアーキテクチャ、クラウドベースのスケーラビリティを求められることが増えています。このような複雑なシステムでは、Auto Increment方式のIDには限界が顕在化します。スケールアウトや複数の書き込みノードが存在する環境では、IDの衝突を避けるために追加の工夫が必要となり、管理が複雑になりがちです。さらに、IDが予測可能なシーケンスであることは、セキュリティー上のリスクをもたらす可能性があります。

これらの課題に対処するため、UUID、ULID、Snowflakeなどの新しい形式の識別子が登場しました。これらはユニークさ、スケーラビリティ、生成の予測不可能性など、特定の利点を提供し、厳しい要求を持つ現代のアプリケーションのニーズに応えることを目指しています。本記事では、これらの識別子の機能と、それぞれが最適な状況について掘り下げていきます。

# データ識別子

## Auto Increment

| id  | name  | email             |
| --- | ----- | ----------------- |
| 1   | Alice | alice@example.com |
| 2   | Bob   | bob@example.com   |
| 3   | Peter | peter@example.com |
| 4   | Tom   | tom@example.com   |

### 構造

<!-- textlint-disable -->

整数（Int）型

<!-- textlint-enable -->

### 特徴

- 整数型を使用し、通常は1から始まる連番です
- 新しいレコードがデータベースに挿入されるたびに、自動的に次の番号がIDに割り当てられます
- 多くのオブジェクトリレーショナルマッピング（ORM）フレームワークやウェブアプリケーションフレームワークがデフォルトで使用します

## UUID v4

| id                                   | name  | email             |
| ------------------------------------ | ----- | ----------------- |
| 550e8400-e29b-41d4-a716-446655440000 | Alice | alice@example.com |
| 123e4567-e89b-12d3-a456-426614174000 | Bob   | bob@example.com   |
| 0c74f13f-fa83-4c48-9b33-689fed9a34b7 | Peter | peter@example.com |
| 5f9c7df8-3d59-4846-99fe-c4518e82c86f | Tom   | tom@example.com   |

### 構造

<!-- textlint-disable -->

128bit長、16進数表記

<!-- textlint-enable -->

- ランダム値（122 bit）
- バージョンとバリアント（6 bit）

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                            rand_a                             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |            rand_a             |  ver  |       rand_b          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |var|                        rand_c                             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                            rand_c                             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 特徴

- 128bit長で、8-4-4-4-12の形式に分かれた16進表記を用いて表されます
- 全世界でユニークな値である可能性が非常に高いです

## ULID

| id                         | name  | email             |
| -------------------------- | ----- | ----------------- |
| 01ARZ3NDEKTSV4RRFFQ69G5FAV | Alice | alice@example.com |
| 01ARYZ6S41TSV4RRFFQ69G5FAV | Bob   | bob@example.com   |
| 01AS3YPYXJTSV4RRFFQ69G5FAV | Peter | peter@example.com |
| 01B2M2Y8JPTSV4RRFFQ69G5FAV | Tom   | tom@example.com   |

### 構造

<!-- textlint-disable -->

128bit長、16進数表記

<!-- textlint-enable -->

- タイムスタンプ（48 bit）
- ランダム値（80 bit）

### 特徴

- Base32エンコーディングを使用し、26文字のアルファベットと数字で構成されます
- 時系列情報を含み、生成された順にソートが可能です

## Snowflake

| id                  | name  | email             |
| ------------------- | ----- | ----------------- |
| 1382971839180339201 | Alice | alice@example.com |
| 1382971839180339202 | Bob   | bob@example.com   |
| 1382971839180339203 | Peter | peter@example.com |
| 1382971839180339204 | Tom   | tom@example.com   |

### 構造

<!-- textlint-disable -->

64bit整数

<!-- textlint-enable -->

- 符号bit（1 bit）
- タイムスタンプ（41 bit）
- ワーカーID（10 bit）
  - データセンターID（5 bit）
  - マシンID（5 bit）
- シーケンス番号（12 bit）

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |0|                        timestamp(ms)                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |   timestamp(ms)   |    worker id      |    sequence number    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 特徴

- Twitterによって開発された方式（[参考](https://github.com/twitter-archive/snowflake)）です
- タイムスタンプ、データセンターまたはワーカーノードのID、シーケンス番号の情報が含まれています
- 時系列情報が組み込まれているため、生成された順番に沿ってソート可能です

## UUID v7

| id                                   | name  | email             |
| ------------------------------------ | ----- | ----------------- |
| 01715b4c-b8e7-7d59-b6e7-6967c6c7c080 | Alice | alice@example.com |
| 01715b4c-b8e8-7dfa-a470-8969b8b8b890 | Bob   | bob@example.com   |
| 01715b4c-b8e9-7e1b-b6f8-9968d6d8d8a0 | Peter | peter@example.com |
| 01715b4c-b8ea-7e5c-b7e9-a678c7c8c8b0 | Tom   | tom@example.com   |

### 構造

<!-- textlint-disable -->

128bit長、16進数表記

<!-- textlint-enable -->

- タイムスタンプ（48 bit）
- バージョンとバリアント（6 bit）
- ランダム値（74 bit）

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                           unix_ts_ms                          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |          unix_ts_ms           |  ver  |       rand_a          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |var|                        rand_b                             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                            rand_b                             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 特徴

- UUIDの新しいバージョンで、時系列順序に基づいたID生成が可能です
- ソート可能な時系列情報を含んでおり、UUID v4よりも高度な時系列管理が可能です

# データ識別子の比較

<!-- textlint-disable -->

| 特徴                       | Auto Increment   | UUID v4      | ULID                 | Snowflake            | UUID v7              |
| -------------------------- | ---------------- | ------------ | -------------------- | -------------------- | -------------------- |
| IDのサイズ                 | 4-8 byte         | 16 byte      | 16 byte              | 8 byte               | 16 byte              |
| IDの視認性                 | 高               | 低           | 中                   | 中                   | 中                   |
| IDの推測容易性             | 高               | 低           | 中                   | 中                   | 中                   |
| IDの衝突耐性               | 高               | 非常に高     | 非常に高             | 最高                 | 非常に高             |
| ID生成の限界               | データベース依存 | 理論上は無限 | 時刻ベースの限界あり | 時刻ベースの限界あり | 時刻ベースの限界あり |
| 分散サポート               | 低               | 高           | 高                   | 高                   | 高                   |
| 誤操作の検出容易性         | 低               | 高           | 中                   | 中                   | 中                   |
| レコード挿入パフォーマンス | 高               | 低           | 中                   | 中                   | 中                   |
| 実装の複雑さ               | 低               | 低           | 低                   | 中〜高               | 低                   |
| 拡張性と互換性             | 低               | 高           | 高                   | 中                   | 高                   |

<!-- textlint-enable -->

## IDのサイズ

### Auto Increment

この方式では、使用される整数型によってIDのサイズが変わります。例えば、INT型では4バイト、BIGINT型では8バイトを使用します。選択されたデータ型によってIDの最大値が決まり、それによってサイズが4バイトか8バイトかが決定されます。

### Snowflake

このID生成方式は8バイトのサイズを持ち、一意性とタイムスタンプ情報を組み込んでいます。

### UUID v4、ULID、UUID v7

これらはすべて128ビット長を使用し、16バイトのIDを生成します。

## IDの視認性

### Auto Increment

この方式は高い視認性を持ちます。数値が連続しているため、人間が見て理解しやすく、並び順も容易に把握できます。

### UUID v4

この方式は低い視認性を持ちます。ランダムに生成される長い16バイトの数値は、一見して識別や理解が困難です。

### ULID

ULIDは中程度の視認性を持ちます。タイムスタンプベースの構造を持ち、一部は順序を持っていますが、全体としてはUUID v4ほどではないものの、やや複雑です。

### Snowflake

この方式も中程度の視認性を持ちます。タイムスタンプ情報を含むものの、ID全体としては複雑さがあり、一見して内容を理解するのは難しいです。

### UUID v7

これも中程度の視認性を持ちます。タイムスタンプベースで生成されるものの、UUID v4と同様に16バイトの長さがあり、視認性を下げる要因となります。

## IDの推測容易性

### Auto Increment

<!-- textlint-disable -->

この方式は推測容易性が高いです。IDが順番に増加するため、1つのIDを知っていれば、次や前のIDを簡単に推測できます。これはセキュリティ上の問題を引き起こす可能性があります。

<!-- textlint-enable -->

### UUID v4

UUID v4は推測容易性が低いです。これらのIDはランダムに生成され、特定のパターンや順序がないため、特定のIDを基に他のIDを推測することは非常に困難です。

### ULID

ULIDは推測容易性が中程度です。これらのIDにはタイムスタンプが含まれているため、生成された時間帯をある程度推測できますが、ID全体を正確に予測することは難しいです。

### Snowflake

Snowflake方式も推測容易性が中程度です。タイムスタンプ情報を含むものの、IDの他の部分はランダムまたは独自のロジックに基づいて生成されるため、完全なIDを推測するのは困難です。

### UUID v7

UUID v7も推測容易性が中程度です。これらのIDにはタイムスタンプが含まれていますが、ランダム要素やその他の構成要素が組み合わさっているため、完全なIDを推測することは難しいです。

## IDの衝突耐性

### Auto Increment

通常、データベースで使用され、各新規レコードに対して前のIDから単純に1増加させる方法です。衝突耐性は高いですが、大量のデータや分散システムではIDの同期が問題になることがあります。

### UUID v4

これは128ビットのランダムまたは擬似ランダムIDを生成します。理論上の衝突確率は非常に低いですが、完全な衝突の排除は不可能です。IDの衝突確率P=0.5の試行回数は約230京回です。

### ULID

UUIDと似ていますが、最初の48ビットにミリ秒単位のタイムスタンプを用い、残りの80ビットはランダムです。タイムスタンプの使用によりソートが可能で、UUID v4よりもわずかに低い衝突確率を持ちます。IDの衝突確率P=0.5の試行回数は約1兆回です。

### Snowflake

Twitterが開発した64ビットID生成システムで、タイムスタンプ、ワーカーID、シーケンス番号を組み合わせています。通常41ビットのタイムスタンプを使用し、約69年間のユニークなタイムスタンプを生成可能です。衝突は発生しません。

### UUID v7

60ビットのミリ秒単位のタイムスタンプ、48ビットのランダム値、4ビットのバージョン情報を含む新しい形式のUUIDです。タイムスタンプの使用により、ULIDと同様の利点があります。IDの衝突確率P=0.5の試行回数は約1374億回です。

## ID生成の限界

### Auto Increment

データベースの数値型の最大値に依存します。

### UUID v4

理論上は無限に近いです。128ビット空間は非常に広大で、実用上は枯渇することはほぼあり得ません。

### ULID

約8,919年。48ビットのタイムスタンプ部分による時刻ベースの限界が存在します。

### Snowflake

約69.7年。41ビットのタイムスタンプ部分による時刻ベースの限界があります。

### UUID v7

約36,533,878年。60ビットのタイムスタンプ部分による非常に長い期間の限界があります。

## 分散サポート

### Auto Increment

低い。Auto Increment IDは通常、単一のデータベース依存であり、分散システムではIDの同期や衝突の問題が生じやすい。

### UUID v4

高い。ランダムまたは擬似ランダム生成により、分散環境でのID衝突のリスクが非常に低く、分散システムでの使用に適しています。

### ULID

高い。タイムスタンプとランダム要素の組み合わせにより、分散システムにおいて高いレベルのユニークネスと衝突耐性を提供します。

### Snowflake

高い。ワーカーIDとシーケンス番号の組み合わせにより、分散システム内でユニークなIDを効率的に生成できる設計になっています。

### UUID v7

高い。時刻ベースのタイムスタンプとランダム要素の組み合わせが、分散環境でのIDの衝突を最小限に抑え、高いユニークネスを保証します。

## 誤操作の検出容易性

### Auto Increment

低い。Auto Increment IDは単純な連番であるため、誤操作による異常なID生成や衝突は検出が困難である場合が多い。

### UUID v4

高い。ランダム生成されるUUID v4は、特定のパターンや規則性がないため、生成ルールに基づかないIDは容易に識別可能。

### ULID

中。タイムスタンプ部分とランダム部分の組み合わせにより、誤操作があった場合でもある程度の検出が可能。しかし、完全な確信を持つのは難しい。

### Snowflake

中。タイムスタンプ、ワーカーID、シーケンス番号の特定の構造により、生成規則に沿わないIDはある程度識別可能だが、完全な検出は保証されない。

### UUID v7

中。タイムスタンプとランダム要素の組み合わせにより、生成規則に基づかないIDはある程度検出可能だが、誤操作の全てを確実に検出することは難しい。

## レコード挿入パフォーマンス

### Auto Increment

高速なID生成が可能で、連続する数値を生成するため、データベースのインデックス構造に適しています。これにより、レコード挿入パフォーマンスは高くなります。

### UUID v4

ランダムまたは擬似ランダム生成されるため、生成されたUUIDがデータベースのリーフページに挿入される際、そのページをバッファープールで探さなければなりません。リーフページがバッファープールでヒットしない場合、ストレージに対するI/Oが発生し、パフォーマンスが劣化します。これにより、レコード挿入パフォーマンスは低下することがあります。

### ULID

タイムスタンプとランダム要素の組み合わせにより、一定の順序性を保持しながらもユニークなIDを生成します。しかし、完全な順序性がないため、データベースのインデックスにおけるレコード挿入パフォーマンスはAuto Incrementほど高くなく、中程度です。

### Snowflake

タイムスタンプ、ワーカーID、シーケンス番号を組み合わせて生成されるため、一定の順序性がありますが、完全な連続性は保持されません。これにより、データベースのインデックスへのレコード挿入パフォーマンスは中程度です。

### UUID v7

タイムスタンプとランダム要素の組み合わせにより生成され、一定の時系列的順序を持ちますが、完全な連続性はないため、Auto Incrementと比較して中程度のレコード挿入パフォーマンスを提供します。

## 実装の複雑さ

### Auto Increment

データベースが自動的にIDを生成するため、開発者はこれを直接実装することはありません。

### UUID v4

<!-- textlint-disable -->

既存のライブラリや機能を利用することが一般的です。そのため、実装の複雑さは低いと言えます。

<!-- textlint-enable -->

### ULID

<!-- textlint-disable -->

UUID v4と同様に、多くのプログラミング言語で利用可能なライブラリによって容易に生成できます。タイムスタンプを含むものの、実装の複雑さは低いと言えます。

<!-- textlint-enable -->

### Snowflake

この方式は特定のシステム要件に応じてカスタマイズする必要があるため、実装の複雑さが高いです。ワーカーIDやシーケンス番号の管理が必要になるため、そのロジックを自身で実装する必要があります。

### UUID v7

<!-- textlint-disable -->

最近サポートされてきた新しい形式ですが、多くのプログラミング言語で利用可能なライブラリが提供されており、実装の複雑さはUUID v4やULIDと同様に低いと考えられます。

<!-- textlint-enable -->

## 拡張性と互換性

### Auto Increment

既存のデータベース管理システムとの互換性は高いが、新しい技術や分散システムへの拡張性は限られています。単一のデータベースに依存するため、大規模かつ複雑なシステムへの適用は難しい場合があります。

### UUID v4

広範な技術環境との高い互換性を持ち、多くのシステムやアプリケーションでサポートされています。分散システムや多様なプラットフォームとの統合においても優れた拡張性を示します。

### ULID

UUID v4に似た拡張性を持ち、広範なシステムでの採用が可能です。新しい技術への適応性は一部未知数ですが、タイムスタンプを含む特性は特定のシナリオで有利になる可能性があります。

### Snowflake

特定のアーキテクチャやシステムに最適化された設計のため、拡張性には制限があります。一部の特定用途には適していますが、全般的なシステムとの互換性は限定的です。

### UUID v7

最新のUUID形式であり、拡張性は高いです。UUID v4と同様に分散システムや多様なプラットフォームとの統合においても優れた拡張性を示します。

# ユースケース

# おわりに

# 参考文献

https://speakerdeck.com/matteobertozzi/ulid-vs-uuid
https://www.slideshare.net/moaikids/20130901-snowflake
https://convto.hatenablog.com/entry/2022/05/29/121124
