---
title: "君たちの知らないAPIの話をしよう"
emoji: "👺"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["API", "APIデザインパターン"]
published: false
publication_name: "levtech"
---

# TL;DR


# はじめに
現代のソフトウェア開発において、APIは根幹をなす要素です。その設計は、アプリケーションの機能性、拡張性、そして最終的なユーザー体験に深く関わっています。「**APIデザインパターン**」は、この重要かつ複雑な分野において、読者を確かな理解と実践へと導く貴重なガイドブックです。

https://techplay.jp/book/373

APIの設計は、表面上は単純なように思えるかもしれませんが、その背後には実行可能でありながら表現力があり、シンプルで予測可能なインターフェースを提供することが求められます。これらの原則は、任意のAPIが成功するための基礎を築きます。しかし、実際にこれらの原則を適用しようとした場合、開発者はしばしば複雑さという壁に直面するのです。特に、単純な標準メソッドだけでは、これらの要求を満たすことには限界があります。

そこで「APIデザインパターン」の価値が際立ちます。この本は、API設計の課題を克服するための具体的な手法とデザインパターンを詳述しています。カスタムメソッド、ロングランオペレーション、再実行可能ジョブなど、多様なデザインパターンが紹介されており、これらはAPIの基本原則に忠実でありながら、より複雑な要件や特有の問題に対処するために考案されています。

この記事を通じて、私たちは「APIデザインパターン」から得られる深い洞察を共有し、中級エンジニアが直面するAPI設計の挑戦を解決するための実践的なアプローチを探求します。これは単なる理論の紹介に留まらず、実際のプロジェクトで適用可能な、具体的な知識と手法の提供を目指しています。

# そもそも良いAPIとは？
![良いAPIとは？](/images/talk_about_apis_you_dont_know_about/good_api.png)

## Executable -実行可能であること-
APIの設計において最も基本的かつ重要な要素は「**実行可能性**」です。これは、システムがユーザーが行いたいことを実際に遂行できる能力を持つことを意味します。

例えば、言語翻訳システムの場合、その主要な機能である翻訳が確実に行えることが必須です。 

しかし、実行可能性は単に基本機能の提供だけに留まらず、その他の要件を満たすことも含まれます。翻訳システムの例を挙げると、重要な要件としては、翻訳の遅延が極めて少ないこと（数日ではなく数ミリ秒で翻訳が完了すること）や、翻訳結果の正確さ（文意が正しく伝わること）などが挙げられます。

実行可能なシステムは、ユーザーの要求を満たすだけでなく、迅速かつ正確な結果を提供することで、信頼性とユーザーエクスペリエンスを高めます。このように、実行可能性はAPI設計の根幹をなす要素であり、全体の機能と性能に直接的な影響を与えます。

## Expressive -表現力があること-
良いAPIは、実行可能性に加えて高い「**表現力**」を持つ必要があります。これは、ユーザーが望む機能をシンプルかつ直感的に実現できることを意味します。APIが提供する機能は、ユーザーが容易に理解し、使用できるように設計されていなければなりません。

例えば、言語翻訳APIが`TranslateText()`というメソッドを提供する場合、その使用法は明確でシンプルであるべきです。しかし、単に翻訳機能を提供するだけでなく、ユーザーが自然に他の関連機能を求めることも考慮すべきです。言語翻訳の例で言えば、ユーザーは単にテキストを翻訳するだけでなく、どの言語で書かれているかを知りたい場合もあります。このニーズに応えるためには、`DetectLanguage()`のようなメソッドを提供することで、ユーザーが`TranslateText()`を用いてどの言語で書かれているかを知ろうとするといった回避策を取る必要がなくなります。

実際には、このような表現力を持つAPIを設計することは容易ではありません。API設計者は、ユーザーがどのようにAPIを使用するかを深く理解し、ユーザーの要求を先読みして適切な機能を提供する必要があります。このプロセスには、ユーザーフィードバックの収集と分析、利用パターンの観察、そして時には創造的な問題解決が必要です。表現力の高いAPIは、ユーザーが直感的に理解しやすく、より満足度の高い体験を提供します。

## Simple -シンプルであること-
良いAPI設計において重要なのは、その「**シンプルさ**」です。シンプルさとは、APIに含まれる要素（RPCやリソースなど）の数を単純に減らすことではなく、ユーザーが必要とする機能を最も直接的かつ簡単な方法で利用できるようにすることです。

例えば、あらゆる機能を一つのメソッド`ExecuteAction()`で処理するような設計は、実際には複雑さを一箇所から別の箇所へ移動させているだけであり、真のシンプルさを実現しているとは言えません。

シンプルなAPI設計の目指すべきは、利用者が求める機能を最も単純な形で提供することです。例えば、翻訳APIで言語検出機能を追加する場合、その機能を別の目的で設計されたメソッドに隠すのではなく、そのための専用メソッド（例えば`DetectLanguage()`）を設けることが理想的です。これにより、機能は利用者にとって理解しやすくなります。

また、シンプルさを追求する際には、一般的な機能は簡単に使えるようにしつつ、高度な機能も提供できるように設計することが大切です。つまり、APIが高度な機能を提供する場合でも、一般的なユーザーにはその複雑さが隠蔽されているべきです。例えば、翻訳APIに機械学習モデルを選択する高度な機能を追加することは、柔軟性とコントロールを提供しますが、その結果としてAPIが複雑になるリスクがあります。

## Predictable -予測可能であること-
良いAPIは、ユーザーに予期せぬ驚きを与えることなく、「**予測可能**」でなければなりません。驚かせないAPIとは、定義や基本動作が一貫しており、ユーザーが直感的に理解できるものです。この原則は、APIの設計全体において、特に名前付けや動作パターンにおいて重要です。

例えば、翻訳APIが`TranslateText()`というメソッドを持ち、その入力フィールドが「text」と名付けられている場合、他の関連メソッド（例えば`DetectLanguage()`）でも同じ名前のフィールドを用いるべきです。このような一貫性は、APIの利用者がドキュメントを全て熟読することは稀で、必要な部分のみに焦点を当てることが多いため、特に重要です。利用者は既に学んだパターンを基に新しい機能を推測しようとします。異なるフィールド名や動作が登場すると、利用者は混乱し、生産性が低下します。

予測可能性は、学習しやすさと速さに直結します。一貫したフィールド名や標準メソッドなど、繰り返し出てくるパターンを持つAPIは、利用者にとって習得が容易で、効率的です。このように、よく知られ、よく定義された明確なパターンを使用することで、APIは予測可能で、全体として「より良い」APIになります。

予測可能なAPIは、利用者が自信を持って使用できるようにし、生産性を高めるために不可欠です。利用者が何を期待するかを理解し、それに応えることで、APIはより使いやすく、効果的なものになります。

# 馴染みのあるAPI設計
# デザインパターンの紹介
本セクションでは、APIのデザインパターンについて、実際のTypeScriptのソースコードを用いることで、理論だけではなく、実践に基づいた深い理解を促します。TypeScriptは多くの開発者にとって馴染み深い言語であり、APIの概念を明確に示すのに適しています。

また、APIメソッドの入出力に関する考察も行います。リクエストとレスポンスのインターフェースを使用し、メソッド名には慣例として`Request`や`Response`を接尾辞に付けます。

さらに、TypeScriptのデコレータを活用してRESTfulなAPIメソッドで実装例を示します。これは、APIがHTTPメソッドやURLにどのようにマッピングされるかを理解するのに役立ちます。

## カスタムメソッド
### 概要
カスタムメソッドは、APIの標準メソッドの範囲外で使用され、標準メソッドの厳格な要件を満たす必要がない操作に採用されます。標準メソッドが広範囲にわたるガイドラインやルールに従う必要があるのに対し、カスタムメソッドはほとんど制約がなく、状況に応じて最適な行動を取ることができます。しかし、APIの利用者はカスタムメソッドに対して標準メソッドと同様の多くの仮定を行うことができないため、API全体で一貫性を持たせることが重要です。

https://cloud.google.com/apis/design/custom_methods?hl=ja

### 対象とする問題
多くのAPIでは、標準メソッドに適合しない特定の操作を実行する必要があります。例えば、メール送信や即時の文書翻訳などは、通常のcreateやupdateメソッドで処理するには不適切です。カスタムメソッドは、これらの非標準的な操作を可能にし、APIの利便性を高めるために存在します。

### 問題点
カスタムメソッドは、適切なリソースセットがあれば標準メソッドで実現可能なことを行う手段として使用されますが、不適切なリソースレイアウトを正当化したり、過剰に使用されることでAPI設計が悪化する可能性があります。

### 実装例
カスタムメソッドは標準メソッドと似た形式で実装されますが、主な違いはHTTPリクエストの形式にあります。標準メソッドがリクエストパスとHTTPメソッドの組み合わせで操作を識別するのに対し、カスタムメソッドでは特別な書式を用いてリクエストパスに関連情報を配置します。以下はカスタムメソッドを使用してメールを送信する操作を示すTypeScriptの実装例です。

```typescript
abstract class EmailApi {
  @post("/{id=users/*emails/*}:send")
  abstract SendEmail(req: SendEmailRequest): Email;
}

interface Email {
  id: string;
  subject: string;
  content: string;
  state: string;
  deleted: boolean;
  // ...
}
```

## ロングランオペレーション
## 再実行可能ジョブ
## シングルトンサブリソース
### 概要
シングルトンサブリソースとは、あるリソースの構成要素を単なるプロパティから、より独立性の高いエンティティへと進化させる手法です。このアプローチにおいて重要な戦略の一つは、問題のある構成要素をリソース全体と単純なプロパティの間に位置するもの、つまりハイブリッドな存在としてデザインすることです。これにより、フルリソースが提供する特定の特性や機能と、単純なプロパティが持つ他の特性や機能を兼ね備えた新たな形態を創出することが可能になります。

https://cloud.google.com/apis/design/design_patterns?hl=ja#singleton_resources

### 対象とする問題
API設計時、リソースの構成要素がプロパティに適しているにもかかわらず、通常のプロパティとして扱えない場合があります。
以下のような事例はその最たる例です。

#### サイズや複雑さ
単一の構成要素がリソース全体よりも大きく複雑になる場合、リソースから分離するべきです。例えば、大きなバイナリオブジェクトの保存では、バイナリデータをメタデータと共に保持することは少ないです。

#### セキュリティ
リソースの一部が異なるアクセス制限を必要とする場合、それをリソースから完全に分離することが重要です。例えば、従業員データのAPIでは、報酬情報が一般的な情報よりも厳格なアクセス制限を受ける可能性があります。

#### ボラティリティ
リソースの特定構成要素が通常と異なるアクセスパターンを持つ場合、頻繁に更新される要素は他と分離し、独立して更新できるようにするべきです。例えば、ライドシェアのAPIでドライバーの位置情報は頻繁に更新されますが、ナンバープレートなどの情報はそうではありません。

## バッチ処理
## フィルタリング
# おわりに
